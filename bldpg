#!/usr/bin/env bash
PGDIR=$HOME/pg

clean="do"
regress="do"
optimize="no"
# --option sanity if $1 specified
if [ ! -z "$1" -a "$1" != "--noclean" -a "$1" != "--noregress" -a "$1" != "--optimize" ]; then
	echo "** invalid option (allowed values are: --noclean or --noregress or --optimize) **"
	return 1
elif [ "$1" == "--noclean" ]; then
	clean="dont"
elif [ "$1" == "--noregress" ]; then
	regress="dont"
elif [ "$1" == "--optimize" ]; then
	optimize="yes"
fi

# --option sanity if $2 specified
if [ ! -z "$2" -a "$2" != "--noregress" -a "$2" != "--optimize" ]; then
	echo "** option 2 can only ever be --noregress or --optimize **"
	return 1
elif [ "$2" == "--noregress" ]; then
	regress="dont"
elif [ "$2" == "--optimize" ]; then
	optimize="yes"
fi

# --option sanity if $3 specified
if [ ! -z "$3" -a "$3" != "--optimize" ]; then
	echo "** option 3 can only ever be --optimize **"
	return 1
elif [ "$3" == "--optimize" ]; then
	optimize="yes"
fi

# make clean if not asked not to
if [ "$clean" != "dont" ]; then
	gmake clean 2>&1 > /dev/null
	echo "** all cleaned up **"
	echo ""
fi

{
	gccpath=`which gcc`
	if [ "$optimize" = "yes" ]; then
		opt="1";
	else
		opt="0";
	fi
	echo "Building with: $gccpath [-O$opt]"
    CFLAGS="-O$opt -g3 -fno-omit-frame-pointer -Wunused -Wreturn-type -Wall -Wmaybe-uninitialized" \
    ./configure --enable-debug --enable-cassert --enable-tap-tests --prefix=$PGDIR/install/head
    gmake -j3
    gmake install
} 2>&1 | grep -B1 "Building with\|warning:\|error:"

# done building. run make check if not asked not to.
if [ "$regress" != "dont" ]; then
	gmake check
fi

# add to PATH only if not already done
currentpgpath=`which postgres`
newpgpath=$PGDIR/install/head/bin/postgres
if [ "$currentpgpath" == "$newpgpath" ]; then
	PATH=$PATH
else
	PATH=$PGDIR/install/head/bin:$PATH
fi
export PATH
return 0
